<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>brianjw:GoogleMapsMod</id>
	<name>Google Member Map</name>

	<file name="$sourcedir/Load.php">
		<operation>
			<search position="before"><![CDATA[
		'website' => array(
			'title' => $profile['website_title'],
			'url' => $profile['website_url'],
		),]]></search>
			<add><![CDATA[
		'googleMap' => array(
			'latitude' => !isset($profile['latitude']) ? '' : $profile['latitude'],
			'longitude' => !isset($profile['longitude']) ? '' : $profile['longitude'],
			'pindate' => !isset($profile['pindate']) ? '' : $profile['pindate'],
		),]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			mem.buddy_list, mg.online_color AS member_group_color, IFNULL(mg.group_name, {string:blank_string}) AS member_group,]]></search>
			<add><![CDATA[
			mem.buddy_list, mem.latitude, mem.longitude, mem.pindate, mg.online_color AS member_group_color, IFNULL(mg.group_name, {string:blank_string}) AS member_group,]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			mem.notify_types, lo.url, mg.online_color AS member_group_color, IFNULL(mg.group_name, {string:blank_string}) AS member_group,]]></search>
			<add><![CDATA[
			mem.notify_types, mem.latitude, mem.longitude, mem.pindate, lo.url, mg.online_color AS member_group_color, IFNULL(mg.group_name, {string:blank_string}) AS member_group,]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Profile-Modify.php">
		<operation>
			<search position="before"><![CDATA[
	$profile_strings = array(
		'buddy_list',
		'ignore_boards',
	);
]]></search>
			<add><![CDATA[
	if (isset($_POST['latitude']))
		$profile_vars['latitude'] = $_POST['latitude'] != '' ? $_POST['latitude'] : 'NULL';
	if (isset($_POST['longitude']))
		$profile_vars['longitude'] = $_POST['longitude'] != '' ? $_POST['longitude'] : 'NULL';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			'karma_good', 'hr',
			'website_title', 'website_url',
]]></search>
			<add><![CDATA[
			'karma_good', 'hr',
			'latitude', 'hr',
			'website_title', 'website_url',
]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
		'karma_good' => array(
			'type' => 'callback',
			'callback_func' => 'karma_modify',
			'permission' => 'admin_forum',
]]></search>
			<add><![CDATA[
		'latitude' => array(
			'type' => 'callback',
			'callback_func' => 'googlemap_modify',
			'permission' => 'googleMap_place',
			// Set longitude and pin date too!
			'input_validate' => create_function('&$value', '
				global $profile_vars, $cur_profile;

				$value = (float) $value;
				if (isset($_POST[\'longitude\']))
				{
					$profile_vars[\'longitude\'] = !empty($_POST[\'longitude\']) ? (float) $_POST[\'longitude\'] : 0;
					$cur_profile[\'longitude\'] = !empty($_POST[\'longitude\']) ? (float) $_POST[\'longitude\'] : 0;
				}
				$pintime = time();
				$profile_vars[\'pindate\'] = (int) $pintime;
				$cur_profile[\'pindate\'] = (int) $pintime;

				return true;
			'),
			'preload' => create_function('', '
				global $context, $cur_profile;

				$context[\'member\'][\'googleMap\'][\'latitude\'] = $cur_profile[\'latitude\'];
				$context[\'member\'][\'googleMap\'][\'longitude\'] = $cur_profile[\'longitude\'];
				$context[\'member\'][\'googleMap\'][\'pindate\'] = $cur_profile[\'pindate\'];

				return true;
			'),
		),]]></add>
		</operation>
	</file>

	<file name="$themedir/Profile.template.php" error="skip">
		<operation>
			<search position="replace"><![CDATA[					<dd>', $context['member']['last_login'], '</dd>
				</dl>';
]]></search>
			<add><![CDATA[				<dd>', $context['member']['last_login'], '</dd>';

	if (!empty($modSettings['googleMapsEnable']) && allowedTo('googleMap_view'))
	{
		$modSettings['googleMapsKey'] = !empty($modSettings['googleMapsKey']) ? $modSettings['googleMapsKey'] : '';
		if (isset($context['member']['googleMap']['longitude']) && isset($context['member']['googleMap']['latitude']) && ($context['member']['googleMap']['longitude'] != 0.0) && ($context['member']['googleMap']['latitude'] != 0.0))
		{
			echo '
	</dl>
<hr />
<br />
<dl>
	<dt>', $txt['googleMapWhere'], '', $context['member']['name'], '</dt>
	<dd>
		<script type="text/javascript" language="JavaScript" src="http://maps.google.com/maps?file=api&v=2&key=', $modSettings['googleMapsKey'], '"></script>
		<div id="map" style="width: 100%; height: 350px; color: #000000;"></div>
		<input type="hidden" name="latitude" size="50" value="', $context['member']['googleMap']['latitude'], '" />
		<input type="hidden" name="longitude" size="50" value="', $context['member']['googleMap']['longitude'], '" />
		<input type="hidden" name="pindate" size="50" value="', $context['member']['googleMap']['pindate'], '" />
		<script type="text/javascript" language="JavaScript"><!-- // -->', chr(60), '![CDATA[
			function LoadMap() {
				var map = new GMap2(document.getElementById("map"));
				map.addControl(new ', $modSettings['googleNavType'], '());
				map.addControl(new GMapTypeControl());
				map.setCenter(new GLatLng(', $context['member']['googleMap']['latitude'], ',', $context['member']['googleMap']['longitude'], '), 13, ', $modSettings['googleMapsType'], ');
				var point = new GLatLng(', $context['member']['googleMap']['latitude'], ',', $context['member']['googleMap']['longitude'], ');
				var marker = new GMarker(point);
				map.addOverlay(marker);
			}
			if (GBrowserIsCompatible()) {
				window.onload=LoadMap;
			}
		// ]]', chr(62), '</script>
	</dd>
</dl>';
		}
	}
]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[
								(', $txt['total'], ': <span id="karmaTotal">', ($context['member']['karma']['good'] - $context['member']['karma']['bad']), '</span>)
							</dd>';
}
]]></search>
			<add><![CDATA[

// Google Map Member Map
function template_profile_googlemap_modify()
{
	global $txt, $modSettings, $context;

	if (!empty($modSettings['googleMapsEnable']) && allowedTo('googleMap_view')) 
	{
		$modSettings['googleMapsKey'] = !empty($modSettings['googleMapsKey']) ? $modSettings['googleMapsKey'] : '';
		
		echo '
<dt><strong>', $txt['googleMap'], '</strong><br /><span class="smalltext">'. $txt['googleMapPleaseClick'].'<br />' . $txt['googleMapDisclaimer'] . '</span></dt>
<dd>
<style type="text/css">
	@import url("http://www.google.com/uds/css/gsearch.css");
	@import url("http://www.google.com/uds/solutions/localsearch/gmlocalsearch.css");
	#map input, textarea {background-color: #ffffff;}
</style>
<br />
        <script type="text/javascript" language="JavaScript" src="http://maps.google.com/maps?file=api&v=2&key=' . $modSettings['googleMapsKey'] . '"></script>
        <script type="text/javascript" language="JavaScript" src="http://www.google.com/uds/api?file=uds.js&amp;v=1.0" ></script>
        <script type="text/javascript" language="JavaScript" src="http://www.google.com/uds/solutions/localsearch/gmlocalsearch.js"></script>
        <div id="map" style="width: 100%; height: 350px; color: #000000;" align="center"></div>
        <input type="hidden" name="latitude" id="latitude" size="50" value="', $context['member']['googleMap']['latitude'], '" />
        <input type="hidden" name="longitude" id="longitude" size="50" value="', $context['member']['googleMap']['longitude'], '" />
        <input type="hidden" name="pindate" id="pindate" size="50" value="', $context['member']['googleMap']['pindate'], '" />
        <script type="text/javascript" language="JavaScript"><!-- // -->', chr(60), '![CDATA[
	
		function LoadMap() {
			var map = new GMap2(document.getElementById("map"));
			map.addControl(new ', $modSettings['googleNavType'], '());
			map.addControl(new GMapTypeControl());
			var options = {
				suppressInitialResultSelection : true, 
				resultList : google.maps.LocalSearch.RESULT_LIST_SUPPRESS
			};
			map.addControl(new google.maps.LocalSearch(options), new GControlPosition(G_ANCHOR_BOTTOM_LEFT, new GSize(4,4)));';
 
		if (isset($context['member']['googleMap']['longitude']) && isset($context['member']['googleMap']['latitude']) && ($context['member']['googleMap']['longitude'] != 0.0) && ($context['member']['googleMap']['latitude'] != 0.0))
		{
			echo '
			map.setCenter(new GLatLng(', $context['member']['googleMap']['latitude'], ',', $context['member']['googleMap']['longitude'], '), 13, ', $modSettings['googleMapsType'], ');
			var point = new GLatLng(', $context['member']['googleMap']['latitude'], ',', $context['member']['googleMap']['longitude'], ');
			var marker = new GMarker(point);
			map.addOverlay(marker);';
		}
		else 
		{
			echo '
			map.setCenter(new GLatLng(0,0), 1, G_NORMAL_MAP);';
		}
	
		echo '
			GEvent.addListener(map, "click", function(overlay, point) {
				if (overlay) {
					map.clearOverlays();
					document.getElementById("latitude").value = "";
					document.getElementById("longitude").value = "";
				}
				else if (point) {
					map.clearOverlays();
					map.addOverlay(new GMarker(point));
					map.panTo(point);
					document.getElementById("latitude").value = point.y;
					document.getElementById("longitude").value = point.x;
				}
			});
		}
		if (GBrowserIsCompatible()) {
			window.onload=LoadMap;
		}
		// ]]', chr(62), '</script>
</dd>';
	}
}
]]></add>
		</operation>
	</file>	

</modification>